# Subscription URL Redirect Server

A lightweight Go web server that redirects old Marzneshin subscription URLs to new Pasarguard subscription URLs based on a mapping configuration file.

## Features

- **Fast O(1) URL lookups** using in-memory hash map
- **Configurable redirect domain** - redirect to a different domain or use the request domain
- **Optional HTTPS support** with embedded SSL certificates (no external files needed)
- **Graceful shutdown** with proper cleanup
- **Detailed logging** for monitoring redirects
- **301 Permanent Redirects** for SEO and caching benefits

## Prerequisites

- Go 1.18 or higher
- A mapping configuration file (generated by the migration tool)

## Installation

1. Navigate to the redirect-server directory:
```bash
cd redirect-server
```

2. Build the server:
```bash
go build -o redirect-server
```

## Configuration

The server reads its configuration from a JSON file (default: `subscription_url_mapping.json`). You can specify a different file using the `-config` flag.

### Configuration File Structure

```json
{
  "server": {
    "host": "0.0.0.0",
    "port": 8080,
    "redirect_domain": "",
    "ssl": {
      "enabled": false,
      "cert": "",
      "key": ""
    }
  },
  "mappings": {
    "username1": {
      "user_id": 1,
      "old_subscription_url": "/sub/username1/key123",
      "new_subscription_url": "/sub/token456"
    }
  }
}
```

### Server Configuration Options

| Field | Type | Description |
|-------|------|-------------|
| `host` | string | The host address to bind to (e.g., `0.0.0.0` for all interfaces, `127.0.0.1` for localhost) |
| `port` | integer | The port to listen on (1-65535) |
| `redirect_domain` | string | Optional. If set, all redirects will use this domain. If empty, uses the request's domain. Examples: `https://new.example.com` or `new.example.com` |
| `ssl.enabled` | boolean | Enable HTTPS mode |
| `ssl.cert` | string | PEM-encoded SSL certificate (required if SSL enabled) |
| `ssl.key` | string | PEM-encoded SSL private key (required if SSL enabled) |

### Redirect Domain Behavior

- **Empty (`""`)**: Uses the request's scheme and host
  - Request: `http://old.example.com/sub/user1/key123`
  - Redirect: `http://old.example.com/sub/newtoken456`

- **Set (e.g., `"https://new.example.com"`)**: Uses the specified domain
  - Request: `http://old.example.com/sub/user1/key123`
  - Redirect: `https://new.example.com/sub/newtoken456`

## Usage

### Basic Usage (HTTP)

```bash
./redirect-server
```

This starts the server using the default configuration file `subscription_url_mapping.json`.

### Custom Configuration File

```bash
./redirect-server -config /path/to/custom_mapping.json
```

### Example Configurations

#### 1. HTTP Server on Port 8080 (Same Domain)

```json
{
  "server": {
    "host": "0.0.0.0",
    "port": 8080,
    "redirect_domain": "",
    "ssl": {
      "enabled": false
    }
  }
}
```

#### 2. HTTP Server with Custom Redirect Domain

```json
{
  "server": {
    "host": "0.0.0.0",
    "port": 8080,
    "redirect_domain": "https://new-server.example.com",
    "ssl": {
      "enabled": false
    }
  }
}
```

#### 3. HTTPS Server with Embedded Certificates

```json
{
  "server": {
    "host": "0.0.0.0",
    "port": 443,
    "redirect_domain": "",
    "ssl": {
      "enabled": true,
      "cert": "-----BEGIN CERTIFICATE-----\nMIIC...\n-----END CERTIFICATE-----",
      "key": "-----BEGIN PRIVATE KEY-----\nMIIE...\n-----END PRIVATE KEY-----"
    }
  }
}
```

## How It Works

1. **Startup**: The server loads the mapping configuration and builds an in-memory lookup table from old paths to new URLs
2. **Request Handling**: When a request arrives:
   - Extracts the path from the request URL
   - Looks up the path in the mapping (O(1) operation)
   - If found: constructs the redirect URL and sends a 301 redirect
   - If not found: returns a 404 Not Found

3. **Redirect URL Construction**:
   - If the new URL is absolute (has `http://` or `https://`), uses it as-is
   - If `redirect_domain` is set, prepends it to the new path
   - Otherwise, uses the request's scheme and host

## Monitoring

The server logs all redirects and errors:

```
2025/01/15 12:00:00 Starting Subscription URL Redirect Server...
2025/01/15 12:00:00 Loaded configuration with 2455 user mappings
2025/01/15 12:00:00 Built path lookup with 2455 entries
2025/01/15 12:00:00 Starting HTTP server on 0.0.0.0:8080
2025/01/15 12:00:00 Server started successfully. Press Ctrl+C to stop.
2025/01/15 12:00:01 Redirecting: /sub/user1/key123 -> /sub/newtoken456
2025/01/15 12:00:02 404 Not Found: /sub/unknown/path
```

## Graceful Shutdown

Press `Ctrl+C` to gracefully shut down the server. The server will:
1. Stop accepting new connections
2. Wait for existing requests to complete (up to 10 seconds)
3. Exit cleanly

## Production Deployment

### Using systemd (Linux)

Create a systemd service file `/etc/systemd/system/redirect-server.service`:

```ini
[Unit]
Description=Subscription URL Redirect Server
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/redirect-server
ExecStart=/opt/redirect-server/redirect-server -config /opt/redirect-server/mapping.json
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
```

Enable and start:
```bash
sudo systemctl enable redirect-server
sudo systemctl start redirect-server
sudo systemctl status redirect-server
```

### Behind a Reverse Proxy (nginx)

If running behind nginx, make sure nginx passes the original protocol:

```nginx
location / {
    proxy_pass http://localhost:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

## Troubleshooting

### Port Already in Use
If you get "address already in use" error, either:
- Change the port in the configuration
- Stop the service using that port

### SSL Certificate Errors
Ensure your certificate and key are in PEM format and properly formatted with newlines preserved.

### 404 Errors
- Check that the mapping file was generated correctly
- Verify the old URL path matches exactly (including leading slash)
- Check the server logs for the exact path being requested

## Performance

- **Memory**: ~50-100 MB for 10,000 mappings
- **Latency**: < 1ms per redirect (in-memory lookup)
- **Throughput**: Supports thousands of requests per second

## License

This tool is part of the Marzneshin to Pasarguard migration toolkit.
